{% extends 'base.html' %}

{% block title %} Home {% endblock title %}

{% block body %}
<div class="main-content">
    <div class="output-box"></div>
    <div class="input-selects">
        <p class="output-data"></p>
        <button id="refresh_btn">Refresh</button>
        <button id="stop_btn">Stop</button>
    </div>
</div>

<div class="test-content">
    <form class="image-form" id="upload-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="input-box">
            <input type="file" id="file-input" name="image" accept="image/*">
            <label for="file-input" class="drag-drop" id="preview-image">Upload Photo</label>
        </div>

        <div class="input-selects">
            <label>
                Model : YOLOv3
                <!-- <select name="model" id="">
                    <option value="yolov5s">YOLOv5s</option>
                    <option value="yolov5m">YOLOv5m</option>
                    <option value="yolov5s6">YOLOv5s6</option>
                    <option value="yolov5m6">YOLOv5m6</option>
                </select> -->
            </label>

            <label>
                Image Size : 640*640
                <!-- <select name="size" id="">
                    <option value="320">320</option>
                    <option value="640">640</option>
                </select> -->
            </label>

            <label> Confidence Threshold : 0.3
                <!-- <input type="range" name="confidence" id="" step="0.01" min="0.01" max="1">
                <output class="bubble" style="left: calc(25% + 4.25px);">
                    0.25 </output> -->
            </label>
            <label> IoU Threshold : 0.5
                <!-- <input type="range" name="iou" id="" min="0" step="0.01" max="0.95">
                <output class="bubble" style="left: calc(47.3684% + 0.736842px);">
                    0.45 </output> -->
            </label>

            <button type="submit" id="submit-button">Predict</button>
            <p id="total-class-data" style="max-width: 250px;"></p>
            <p id="total-chair-data"></p>
            <p id="total-person-data"></p>
            <p id="occupied-chair-data"></p>
            <p id="vacant-chair-data"></p>
        </div>
    </form>

    <div class="camera_container">
        <div class="camera-box">
            <video id="webcam" autoplay playsinline width="640" height="640">
            </video>
            <canvas id="canvas" class="d-none"></canvas>
        </div>
        <div class="camera-btns">
            <button id="camera_btn">Open Camera</button>
            <button id="capture_btn">Capture</button>
            <button id="camera_flip_btn">Flip</button>
        </div>
    </div>
</div>

<script>
    const testBtn = document.getElementById("test_btn");
    const homeBtn = document.getElementById("home_btn");
    const refreshBtn = document.getElementById("refresh_btn");
    const stopBtn = document.getElementById("stop_btn");
    var testElement = document.querySelector(".test-content");
    var homeElement = document.querySelector(".main-content");
    let socket;

    // Event listener for connect button click
    homeBtn.addEventListener('click', () => {
        testElement.style.display = "none";
        homeElement.style.display = "flex";
    });

    refreshBtn.onclick = function (e) {
        openSocket();
    };

    stopBtn.onclick = function (e) {
        closeSocket();
    };

    testBtn.onclick = function (e) {
        homeElement.style.display = "none";
        testElement.style.display = "block";
        closeSocket();
    };

    function openSocket() {
        closeSocket();
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            // Create a WebSocket connection
            socket = new WebSocket(
                'ws://'
                + window.location.host
                + '/ws/data-stream/'
            );

            // Event listener for successful connection
            socket.onopen = () => {
                console.log('WebSocket connection established.');
            };

            // Event listener for receiving messages
            socket.onmessage = (event) => {
                console.log(event)
                const response = JSON.parse(event.data);
                let image = response.image
                document.querySelector('.output-box').innerHTML = '';
                document.querySelector('.output-data').innerHTML = '';
                if (image != null) {
                    let img = document.createElement('img');
                    img.setAttribute('src', 'data:image/jpeg;base64,' + image);
                    img.setAttribute('width', '480');
                    img.setAttribute('height', '480');
                    $(".output-box").html(img);
                    // document.querySelector('.output-box').inner=img;
                }
                let data = response.data
                console.log(data)
                if (data != null) {
                    var table = document.createElement("table");
                    table.setAttribute("id", "data_table");
                    var fields = Object.keys(data);
                    for (var i = 0; i < fields.length; i++) {
                        var row = document.createElement("tr");
                        var th = document.createElement("th");
                        th.textContent = fields[i];
                        row.appendChild(th);
                        var td = document.createElement("td");
                        td.textContent = data[fields[i]];
                        row.appendChild(td);
                        table.appendChild(row);
                    }
                    document.querySelector('.output-data').append(table);
                }
            };

            // Event listener for connection close
            socket.onclose = () => {
                console.log('WebSocket connection closed.');
            };
        }
    }
    function closeSocket() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            // Close the WebSocket connection
            const data = {
                message: 'close'
            };
            socket.send(JSON.stringify(data));
            socket.close(1000, "User-initiated disconnect");
            console.log('WebSocket connection closed.');
        }
    }

    const webcamElement = document.querySelector('#webcam');
    const canvasElement = document.querySelector('#canvas');
    const cameraBtn = document.querySelector('#camera_btn');
    const captureBtn = document.querySelector('#capture_btn');
    const cameraFlipBtn = document.querySelector('#camera_flip_btn');
    // const recordBtn = document.querySelector('#record_btn');
    // const stopBtn = document.querySelector('#stop_btn');
    const webcam = new Webcam(webcamElement, 'user', canvasElement);

    function dataUrlToBinaryJpeg(dataUrl) {
        // Remove the "data:image/jpeg;base64," prefix from the data URL
        const base64String = dataUrl.slice("data:image/jpeg;base64,".length);

        // Convert the base64-encoded string to a binary string
        const binaryString = atob(base64String);

        // Convert the binary string to a Uint8Array
        const uint8Array = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            uint8Array[i] = binaryString.charCodeAt(i);
        }

        // Return the Uint8Array, which now contains the binary JPEG data
        return uint8Array;
    }

    function postForm(formData) {
        $.ajax({
            type: "POST",
            url: "{% url 'process_image' %}",
            data: formData,
            processData: false,
            contentType: false,
            dataType: 'json',
            success: function (response) {
                var img = $("<img>").attr({
                    src: "data:image/jpeg;base64," + response.image,
                    width: 640,
                    height: 640
                });
                var data = response.data
                // document.querySelector("#total-class-data").innerHTML = "Detected classes:" + data[0]
                document.querySelector("#total-chair-data").innerHTML = "Chair available:" + (data[3] + data[4])
                document.querySelector("#total-person-data").innerHTML = "No of People:" + data[2]
                document.querySelector("#occupied-chair-data").innerHTML = "Occupied Chair:" + data[3]
                document.querySelector("#vacant-chair-data").innerHTML = "Vacant Chair:" + data[4]
                console.log(data)
                $("#preview-image").html(img);
            },
            error: function (xhr, status, error) {
                alert("Error: " + xhr.responseText);
            }
        });
    }

    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-input');
    const previewImage = document.getElementById('preview-image');
    const submitButton = document.getElementById('submit-button');

    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.addEventListener('load', () => {
            var img = $("<img>").attr({
                src: reader.result,
                width: 640,
                height: 640
            });
            $("#preview-image").html(img);
        });

        if (file) {
            reader.readAsDataURL(file);
        }
    });

    $(document).ready(function () {
        $("#upload-form").submit(function (event) {
            event.preventDefault();
            var form_data = new FormData($("#upload-form")[0]);
            postForm(form_data);
        });
    });

    cameraBtn.addEventListener('click', function () {
        webcam.start()
            .then(result => {
                console.log("webcam started");
            })
            .catch(err => {
                console.log(err);
            });
    });

    cameraFlipBtn.addEventListener('click', function () {
        webcam.flip();
        webcam.start();
    });

    captureBtn.addEventListener('click', function () {
        const imageURL = webcam.snap();
        webcam.stop()

        const binaryJpeg = dataUrlToBinaryJpeg(imageURL);
        console.log(imageURL, binaryJpeg)
        // Create a form with a file input field
        var formData = new FormData();
        formData.append("username", "john123");
        let blob = new Blob([binaryJpeg], { type: 'image/jpeg' });
        let file = new File([blob], 'image.jpeg', { type: 'image/jpeg' });
        formData.append("image", file);
        postForm(formData);

        // document.querySelector('#download-photo').href = picture;

    });

</script>

{% endblock body %}